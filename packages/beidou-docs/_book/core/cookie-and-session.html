
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>Cookie & Session Â· Beidou Document</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../website-1510989186484.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="cluster-and-ipc.html" />
    
    
    <link rel="prev" href="http-client.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    About Beidou
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../quick-start/quick-start.html">
            
                <a href="../quick-start/quick-start.html">
            
                    
                    Quick Start
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Step by Step
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../quick-start/prepare-environment.html">
            
                <a href="../quick-start/prepare-environment.html">
            
                    
                    Environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../quick-start/directory-struct.html">
            
                <a href="../quick-start/directory-struct.html">
            
                    
                    Directory Structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../quick-start/step-by-step.html">
            
                <a href="../quick-start/step-by-step.html">
            
                    
                    Step by Step
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Basics
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../basic/objects.html">
            
                <a href="../basic/objects.html">
            
                    
                    Built-in Objects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../basic/env.html">
            
                <a href="../basic/env.html">
            
                    
                    Runtime Environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../basic/config.html">
            
                <a href="../basic/config.html">
            
                    
                    Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../basic/plugins.html">
            
                <a href="../basic/plugins.html">
            
                    
                    Plugins
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../basic/middleware.html">
            
                <a href="../basic/middleware.html">
            
                    
                    Middlewares
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../basic/router.html">
            
                <a href="../basic/router.html">
            
                    
                    Router
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../basic/controller.html">
            
                <a href="../basic/controller.html">
            
                    
                    Controller
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../basic/service.html">
            
                <a href="../basic/service.html">
            
                    
                    Service
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../basic/schedule.html">
            
                <a href="../basic/schedule.html">
            
                    
                    Schedule
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="../basic/extend.html">
            
                <a href="../basic/extend.html">
            
                    
                    Extend
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.11" data-path="../basic/Mock.html">
            
                <a href="../basic/Mock.html">
            
                    
                    Mock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.12" data-path="../basic/app-start.html">
            
                <a href="../basic/app-start.html">
            
                    
                    Custom startup
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    Core
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="development.html">
            
                <a href="development.html">
            
                    
                    Development
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="unittest.html">
            
                <a href="unittest.html">
            
                    
                    Unit Testing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="logger.html">
            
                <a href="logger.html">
            
                    
                    Logger
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.4" data-path="http-client.html">
            
                <a href="http-client.html">
            
                    
                    HttpClient
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5.5" data-path="cookie-and-session.html">
            
                <a href="cookie-and-session.html">
            
                    
                    Cookie & Session
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="cluster-and-ipc.html">
            
                <a href="cluster-and-ipc.html">
            
                    
                    Cluster and IPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="isomorphic-render.html">
            
                <a href="isomorphic-render.html">
            
                    
                    Ismorphic Render
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8" data-path="error-handling.html">
            
                <a href="error-handling.html">
            
                    
                    Error Handling
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="security.html">
            
                <a href="security.html">
            
                    
                    Security
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.10" data-path="i18n.html">
            
                <a href="i18n.html">
            
                    
                    Multi-language
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Deployment
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../deployment/deployment.html">
            
                <a href="../deployment/deployment.html">
            
                    
                    Deployment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../deployment/devops.html">
            
                <a href="../deployment/devops.html">
            
                    
                    DevOps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../deployment/docker.html">
            
                <a href="../deployment/docker.html">
            
                    
                    Docker
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" >
            
                <span>
            
                    
                    Tutorials
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../tutorials/progressive.html">
            
                <a href="../tutorials/progressive.html">
            
                    
                    Progressive
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../tutorials/mysql.html">
            
                <a href="../tutorials/mysql.html">
            
                    
                    MySQL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../tutorials/restful.html">
            
                <a href="../tutorials/restful.html">
            
                    
                    Restful API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../tutorials/async-function.html">
            
                <a href="../tutorials/async-function.html">
            
                    
                    Async Function
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" >
            
                <span>
            
                    
                    Advanced
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../advanced/architecture.html">
            
                <a href="../advanced/architecture.html">
            
                    
                    How It Works
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../advanced/loader.html">
            
                <a href="../advanced/loader.html">
            
                    
                    Loader
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../advanced/plugin.html">
            
                <a href="../advanced/plugin.html">
            
                    
                    Plugin Development
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="../advanced/cluster-enhancement.html">
            
                <a href="../advanced/cluster-enhancement.html">
            
                    
                    Cluster Enhancement
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="../advanced/monitor.html">
            
                <a href="../advanced/monitor.html">
            
                    
                    Monitor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.6" data-path="../advanced/performance.html">
            
                <a href="../advanced/performance.html">
            
                    
                    Performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.7" data-path="../advanced/oom.html">
            
                <a href="../advanced/oom.html">
            
                    
                    Memory Leaks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.8" data-path="../advanced/attentions.html">
            
                <a href="../advanced/attentions.html">
            
                    
                    SSR Attentions
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../FAQ.html">
            
                <a href="../FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >Cookie & Session</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="cookie-and-session">Cookie and Session</h2>
<h2 id="cookie">Cookie</h2>
<p>HTTP is a stateless protocol.
But web applications often need to identify the sender of requests.
To solve this problem, HTTP protocol defines a header <a href="https://en.wikipedia.org/wiki/HTTP_cookie" target="_blank">Cookie</a>.
Web servers can use response header <code>Set-Cookie</code> to send small data to clients.
Clients (e.g. web browsers) store the data according to protocol,
and attach the cookie data in future requests.
For security reason, browsers only attach cookies in the requests that are sent to the same domain.
Web servers can use <code>Domain</code> and <code>Path</code> attributes to define the scope of the cookie.</p>
<p>By using <code>context.cookies</code>, we can easily and safely read/set cookies in controller.</p>
<pre><code class="lang-js">exports.add = <span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params">ctx</span>) </span>{
  <span class="hljs-keyword">let</span> count = ctx.cookies.get(<span class="hljs-string">&apos;count&apos;</span>);
  count = count ? <span class="hljs-built_in">Number</span>(count) : <span class="hljs-number">0</span>;
  ctx.cookies.set(<span class="hljs-string">&apos;count&apos;</span>, ++count);
  ctx.body = count;
};

exports.remove = <span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params">ctx</span>) </span>{
  ctx.cookies.set(<span class="hljs-string">&apos;count&apos;</span>, <span class="hljs-literal">null</span>);
  ctx.status = <span class="hljs-number">204</span>;
};
</code></pre>
<h4 id="contextcookiessetkey-value-options"><code>context.cookies.set(key, value, options)</code></h4>
<p>Modifying Cookie is done by setting <code>Set-Cookie</code> header in HTTP responses.
Each <code>Set-Cookie</code> creates a key-value pair in client.
Besides of setting the value of Cookie,
HTTP protocol supports more attributes to control the transfer, storage and permission of Cookie.</p>
<ul>
<li>maxAge (Number): set the lifetime of the cookie in milliseconds. It&apos;s the milliseconds since server&apos;s &quot;Now&quot;. Client discards a cookie after specified lifetime.</li>
<li>expires (Date): set the expiration time of the cookie. If <code>maxAge</code> is defined, <code>expires</code> will be ignored. If neither is defined, Cookie will expire when client session expires, usually it&apos;s the time client closed.</li>
<li>path (String): set the path of the cookie. By default it&apos;s on root path (<code>/</code>), which means all URL under the current domain have access to the cookie.</li>
<li>domain (String): set the domain of the cookie. By default, it&apos;s not defined. If defined, only specified domain have access to the cookie.</li>
<li>httpOnly (Boolean): set whether the cookie can be accessed by Javascript. By default it&apos;s <code>true</code>, which means Javascript cannot access the cookie.</li>
<li>secure (Boolean): set whether the cookie can only be accessed under HTTPS. See <a href="http://stackoverflow.com/questions/13729749/how-does-cookie-secure-flag-work" target="_blank">explanation</a> for details. Beidou auto sets this value to true if the current request is sent over HTTPS.</li>
</ul>
<p>In addition to these standard Cookie attributes, beidou supports 3 more parameters:</p>
<ul>
<li>overwrite (Boolean): set the way of handling same Cookie key. If true, earlier called values will be overwritten by the last call; otherwise HTTP response will contain multiple <code>Set-Cookie</code> headers with the same key.</li>
<li>signed (Boolean): set whether the cookie should be signed. If true, the value of the cookie will be signed. So that when the value is being read, server verifies the signature to prevent cookie values modified by client. By default it&apos;s true.</li>
<li>encrypt&#xFF08;Boolean): set whether the cookie should be encrypted. It true, the cookie value will be encrypted before sending to clients so user clients cannot get raw text of the cookie. By default it&apos;s false.</li>
</ul>
<p>When using Cookie, we need to have a clear idea of the purpose of the cookie,
how long it needs to be stored in client, can it be accessed by JS, can it be modified by client.</p>
<p><strong>By default, Cookie is signed but not encrypted,
client can see raw content but cannot modify it (manually).</strong></p>
<ul>
<li>If you need to allow JS to access and modify Cookie:</li>
</ul>
<pre><code class="lang-js">ctx.cookies.set(key, value, {
  httpOnly: <span class="hljs-literal">false</span>,
  signed: <span class="hljs-literal">false</span>,
});
</code></pre>
<ul>
<li>If you don&apos;t want to allow JS to access and modify Cookie:</li>
</ul>
<pre><code class="lang-js">ctx.cookies.set(key, value, {
  httpOnly: <span class="hljs-literal">true</span>, <span class="hljs-comment">// by default it&apos;s true</span>
  encrypt: <span class="hljs-literal">true</span>, <span class="hljs-comment">// cookies are encrypted during network transmission</span>
});
</code></pre>
<p>Note:</p>
<ol>
<li>Due to <a href="http://stackoverflow.com/questions/7567154/can-i-use-unicode-characters-in-http-headers" target="_blank">the uncertainty of client&apos;s implementation</a>, to ensure Cookie can be stored successfully, it&apos;s recommended to encode cookie value in base64 or other codec.</li>
<li>Due to <a href="http://stackoverflow.com/questions/640938/what-is-the-maximum-size-of-a-web-browsers-cookies-key" target="_blank">the limitation of Cookie length on client side</a>, do avoid using long Cookie. Generally speaking, no more than 4093 bytes. When Cookie value&apos;s length is greater than this value, beidou prints a warning in log.</li>
</ol>
<h4 id="contextcookiesgetkey-options"><code>context.cookies.get(key, options)</code></h4>
<p>As HTTP Cookie is sent over header,
we can use this method to easily retrieve the value of given key from Cookie.
If <code>options.signed</code> and <code>options.encrypt</code> has been configured to sign and encrypt Cookie,
the corresponding options also need to be used in <code>get</code> method.</p>
<ul>
<li>If <code>signed</code> is true when <code>set</code> Cookie but false when <code>get</code> Cookie, beidou doesn&apos;t verify Cookie value, so the value could have been modified by client.</li>
<li>If <code>encrypt</code> is true when <code>set</code> Cookie but false when <code>get</code> Cookie, what you get is encrypted text rather than the raw plain text.</li>
</ul>
<h3 id="cookie-secret-key">Cookie Secret Key</h3>
<p>Since we need to sign and encrypt Cookie, a secret key is required.
In <code>config/config.default.js</code>:</p>
<pre><code class="lang-js"><span class="hljs-built_in">module</span>.exports = {
  keys: <span class="hljs-string">&apos;key1,key2&apos;</span>,
};
</code></pre>
<p><code>keys</code> is defined as a string, several keys separated by commas.
When beidou processes Cookie:</p>
<ul>
<li>the first key is used in encryption and signature generation.</li>
<li>to decrypt or verify signature, beidou iterates through all keys.</li>
</ul>
<p>If you need to update Cookie secret key and don&apos;t want to invalidate existing clients&apos; Cookie,
you can add new secret key at the front of <code>keys</code>.
After some time, when existing Cookie has expired, delete the old secret keys.</p>
<h2 id="session">Session</h2>
<p>In web applications, Cookie is usually used to identify users.
So the concept of Session, which is built on top of Cookie,
was created to specifically handle user identification.</p>
<p>Beidou built-in supports Session through <a href="https://github.com/eggjs/egg-session" target="_blank">egg-session</a> plugin.
We can use <code>context.session</code> to read or modify current user session.</p>
<pre><code class="lang-js">exports.fetchPosts = <span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params">ctx</span>) </span>{
  <span class="hljs-comment">// get content from session</span>
  <span class="hljs-keyword">const</span> userId = ctx.session.userId;
  <span class="hljs-keyword">const</span> posts = <span class="hljs-keyword">yield</span> ctx.service.post.fetch(userId);
  <span class="hljs-comment">// modify session value</span>
  ctx.session.visited = ctx.session.visited ? ctx.session.visited++ : <span class="hljs-number">1</span>;
  ctx.body = {
    success: <span class="hljs-literal">true</span>,
    posts,
  };
};
</code></pre>
<p>It is very intuitive to use Session, simply get or set.
To delete a session, set its value to null:</p>
<pre><code class="lang-js">exports.deleteSession = <span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params">ctx</span>) </span>{
  ctx.session = <span class="hljs-literal">null</span>;
};
</code></pre>
<p>Session is built on top of Cookie.
By default, the content of Session is stored in a Cookie field as encrypted string.
Every time a client sends requests to server, the cookie is attached in requests.
Beidou passes decrypted cookie to server code.
The default configuration of Session is:</p>
<pre><code class="lang-js">exports.session = {
  key: <span class="hljs-string">&apos;EGG_SESS&apos;</span>,
  maxAge: <span class="hljs-number">24</span> * <span class="hljs-number">3600</span> * <span class="hljs-number">1000</span>, <span class="hljs-comment">// 1 day</span>
  httpOnly: <span class="hljs-literal">true</span>,
  encrypt: <span class="hljs-literal">true</span>,
};
</code></pre>
<p>The attributes except of <code>key</code> are all standard Cookie attributes.
<code>key</code> is the key of the cookie that stores session content.
With default config, the session cookie is encrypted, not accessible to JS,
which ensures user cannot access or modify it.</p>
<h3 id="store-session-in-other-storage">Store session in other storage</h3>
<p>Session is stored in Cookie by default.
If a session is too big, there are some troubles.</p>
<ul>
<li>as mentioned above, clients usually have limitation on Cookie length. When session is too big, a client may refuse to store it.</li>
<li>Cookie is attached in every request. If session is too big, the additional cost of sending session may be significant.</li>
</ul>
<p>Beidou supports to store Session in other places.
To config it, you can simply set <code>app.sessionStore</code>.</p>
<pre><code class="lang-js"><span class="hljs-comment">// app.js</span>
<span class="hljs-built_in">module</span>.exports = app =&gt; {
  app.sessionStore = {
    * get (key) {
      <span class="hljs-comment">// return value;</span>
    },
    * set (key, value, maxAge) {
      <span class="hljs-comment">// set key to store</span>
    },
    * destroy (key) {
      <span class="hljs-comment">// destroy key</span>
    },
  };
};
</code></pre>
<p>The implementation of <code>sessionStore</code> can also be encapsulated into a plugin.
For example, <a href="https://github.com/eggjs/egg-session-redis" target="_blank">egg-session-redis</a> stores Session in Redis.
To apply it, import <a href="https://github.com/eggjs/egg-redis" target="_blank">egg-redis</a> and <a href="https://github.com/eggjs/egg-session-redis" target="_blank">egg-session-redis</a> plugin in your application.</p>
<pre><code class="lang-js"><span class="hljs-comment">// plugin.js</span>
exports.redis = {
  enable: <span class="hljs-literal">true</span>,
  package: <span class="hljs-string">&apos;egg-redis&apos;</span>,
};
exports.sessionRedis = {
  enable: <span class="hljs-literal">true</span>,
  package: <span class="hljs-string">&apos;egg-session-redis&apos;</span>,
};
</code></pre>
<p><strong>Note: once you choose to store Session in external storage,
it means your system heavily depends on the external storage.
Once it&apos;s down, Session feature won&apos;t work.
So it&apos;s recommended to put only necessary information in Session,
keep Session minimum and use the default Cookie storage if possible.
Do not put per-user&apos;s data cache in Session.</strong></p>
<h3 id="session-practice">Session Practice</h3>
<h4 id="set-sessions-expiration-time">Set session&apos;s expiration time</h4>
<p>Session config has a attribute <code>maxAge</code>, which controls global expiration time of all sessions of the application.</p>
<p>We often can see a <strong>Remember Me</strong> option on a lot of websites&apos; login page.
If it&apos;s selected, Session of this logged in user can live longer.
This kind of per-user session expiration time can be set through <code>context.session.maxAge</code>:</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> ms = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;ms&apos;</span>);
<span class="hljs-comment">// login controller</span>
exports.login = <span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params">ctx</span>) </span>{
  <span class="hljs-keyword">const</span> { username, password, rememberMe } = ctx.request.body;
  <span class="hljs-keyword">const</span> user = <span class="hljs-keyword">yield</span> ctx.loginAndGetUser(username, password);

  <span class="hljs-comment">// set Session</span>
  <span class="hljs-keyword">this</span>.session.user = user;
  <span class="hljs-comment">// if user selected `Remember Me`, set expiration time to 30 days</span>
  <span class="hljs-keyword">if</span> (rememberMe) <span class="hljs-keyword">this</span>.session.maxAge = ms(<span class="hljs-string">&apos;30d&apos;</span>);
};
</code></pre>
<h4 id="extend-sessions-expiration-time">Extend session&apos;s expiration time</h4>
<p>By default, if user requests don&apos;t result in modification of Session,
beidou doesn&apos;t extend expiration time of the session.
But in some scenarios, you may need to refresh expiration time every time user access the website,
so that users will only be logged out when they don&apos;t access website for long time.
This requirement can be done through <code>context.session.save()</code>.</p>
<p>For example, we create a middleware in the application.
It forces saving session in every request, in order to extend session&apos;s expiration time.</p>
<pre><code class="lang-js"><span class="hljs-comment">// app/middleware/save_session.js</span>
<span class="hljs-built_in">module</span>.exports = () =&gt; {
  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params">next</span>) </span>{
    <span class="hljs-keyword">yield</span> next;
    <span class="hljs-comment">// if Session is empty, do nothing</span>
    <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.session.populated) <span class="hljs-keyword">return</span>;
    <span class="hljs-keyword">this</span>.session.save();
  };
};

<span class="hljs-comment">// config/config.default.js</span>
<span class="hljs-comment">// import the middleware in config file</span>
exports.middleware = [ <span class="hljs-string">&apos;saveSession&apos;</span> ];
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="http-client.html" class="navigation navigation-prev " aria-label="Previous page: HttpClient">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="cluster-and-ipc.html" class="navigation navigation-next " aria-label="Next page: Cluster and IPC">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Cookie & Session","level":"1.5.5","depth":2,"next":{"title":"Cluster and IPC","level":"1.5.6","depth":2,"path":"core/cluster-and-ipc.md","ref":"core/cluster-and-ipc.md","articles":[]},"previous":{"title":"HttpClient","level":"1.5.4","depth":2,"path":"core/http-client.md","ref":"core/http-client.md","articles":[]},"dir":"ltr"},"config":{"plugins":["antsay","-sharing","styles-less","livereload"],"styles":{"website":"website-1510989186484.css"},"pluginsConfig":{"antsay":{"useIdentifier":false,"shortName":"","appId":"","key":""},"styles-less":{},"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Beidou Document","gitbook":">= 3.2.0","description":"Beidou Document"},"file":{"path":"core/cookie-and-session.md","mtime":"2017-11-17T13:17:12.000Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2017-11-18T07:04:22.028Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="https://say.alipay.net/public/antsay.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-antsay/bootstrap.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

