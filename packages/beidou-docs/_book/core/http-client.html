
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>HttpClient Â· Beidou Document</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.2">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../website-1510989186484.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="cookie-and-session.html" />
    
    
    <link rel="prev" href="logger.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    About Beidou
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="../quick-start/quick-start.html">
            
                <a href="../quick-start/quick-start.html">
            
                    
                    Quick Start
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" >
            
                <span>
            
                    
                    Step by Step
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.3.1" data-path="../quick-start/prepare-environment.html">
            
                <a href="../quick-start/prepare-environment.html">
            
                    
                    Environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.2" data-path="../quick-start/directory-struct.html">
            
                <a href="../quick-start/directory-struct.html">
            
                    
                    Directory Structure
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3.3" data-path="../quick-start/step-by-step.html">
            
                <a href="../quick-start/step-by-step.html">
            
                    
                    Step by Step
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    Basics
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.4.1" data-path="../basic/objects.html">
            
                <a href="../basic/objects.html">
            
                    
                    Built-in Objects
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="../basic/env.html">
            
                <a href="../basic/env.html">
            
                    
                    Runtime Environment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.3" data-path="../basic/config.html">
            
                <a href="../basic/config.html">
            
                    
                    Configuration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.4" data-path="../basic/plugins.html">
            
                <a href="../basic/plugins.html">
            
                    
                    Plugins
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.5" data-path="../basic/middleware.html">
            
                <a href="../basic/middleware.html">
            
                    
                    Middlewares
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.6" data-path="../basic/router.html">
            
                <a href="../basic/router.html">
            
                    
                    Router
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.7" data-path="../basic/controller.html">
            
                <a href="../basic/controller.html">
            
                    
                    Controller
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.8" data-path="../basic/service.html">
            
                <a href="../basic/service.html">
            
                    
                    Service
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.9" data-path="../basic/schedule.html">
            
                <a href="../basic/schedule.html">
            
                    
                    Schedule
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.10" data-path="../basic/extend.html">
            
                <a href="../basic/extend.html">
            
                    
                    Extend
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.11" data-path="../basic/Mock.html">
            
                <a href="../basic/Mock.html">
            
                    
                    Mock
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.12" data-path="../basic/app-start.html">
            
                <a href="../basic/app-start.html">
            
                    
                    Custom startup
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    Core
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="development.html">
            
                <a href="development.html">
            
                    
                    Development
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="unittest.html">
            
                <a href="unittest.html">
            
                    
                    Unit Testing
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="logger.html">
            
                <a href="logger.html">
            
                    
                    Logger
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.5.4" data-path="http-client.html">
            
                <a href="http-client.html">
            
                    
                    HttpClient
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.5" data-path="cookie-and-session.html">
            
                <a href="cookie-and-session.html">
            
                    
                    Cookie & Session
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.6" data-path="cluster-and-ipc.html">
            
                <a href="cluster-and-ipc.html">
            
                    
                    Cluster and IPC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.7" data-path="isomorphic-render.html">
            
                <a href="isomorphic-render.html">
            
                    
                    Ismorphic Render
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.8" data-path="error-handling.html">
            
                <a href="error-handling.html">
            
                    
                    Error Handling
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.9" data-path="security.html">
            
                <a href="security.html">
            
                    
                    Security
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.10" data-path="i18n.html">
            
                <a href="i18n.html">
            
                    
                    Multi-language
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    Deployment
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="../deployment/deployment.html">
            
                <a href="../deployment/deployment.html">
            
                    
                    Deployment
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="../deployment/devops.html">
            
                <a href="../deployment/devops.html">
            
                    
                    DevOps
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="../deployment/docker.html">
            
                <a href="../deployment/docker.html">
            
                    
                    Docker
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" >
            
                <span>
            
                    
                    Tutorials
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.7.1" data-path="../tutorials/progressive.html">
            
                <a href="../tutorials/progressive.html">
            
                    
                    Progressive
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.2" data-path="../tutorials/mysql.html">
            
                <a href="../tutorials/mysql.html">
            
                    
                    MySQL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.3" data-path="../tutorials/restful.html">
            
                <a href="../tutorials/restful.html">
            
                    
                    Restful API
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.7.4" data-path="../tutorials/async-function.html">
            
                <a href="../tutorials/async-function.html">
            
                    
                    Async Function
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.8" >
            
                <span>
            
                    
                    Advanced
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.8.1" data-path="../advanced/architecture.html">
            
                <a href="../advanced/architecture.html">
            
                    
                    How It Works
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.2" data-path="../advanced/loader.html">
            
                <a href="../advanced/loader.html">
            
                    
                    Loader
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.3" data-path="../advanced/plugin.html">
            
                <a href="../advanced/plugin.html">
            
                    
                    Plugin Development
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.4" data-path="../advanced/cluster-enhancement.html">
            
                <a href="../advanced/cluster-enhancement.html">
            
                    
                    Cluster Enhancement
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.5" data-path="../advanced/monitor.html">
            
                <a href="../advanced/monitor.html">
            
                    
                    Monitor
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.6" data-path="../advanced/performance.html">
            
                <a href="../advanced/performance.html">
            
                    
                    Performance
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.7" data-path="../advanced/oom.html">
            
                <a href="../advanced/oom.html">
            
                    
                    Memory Leaks
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.8.8" data-path="../advanced/attentions.html">
            
                <a href="../advanced/attentions.html">
            
                    
                    SSR Attentions
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.9" data-path="../FAQ.html">
            
                <a href="../FAQ.html">
            
                    
                    FAQ
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >HttpClient</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h2 id="http-client">Http Client</h2>
<p>Countless services rely on the HTTP-based communication nowadays, and it is a very common application scenario that web applications call back-end HTTP services.</p>
<p>The framework built in <a href="https://github.com/eggjs/egg/blob/master/lib/core/httpclient.js" target="_blank">HttpClient</a> based on <a href="https://github.com/node-modules/urllib" target="_blank">urllib</a>, you can quickly complete any HTTP request.</p>
<h2 id="using-httpclient-by-app">Using HttpClient by app</h2>
<p><a href="https://github.com/eggjs/egg/blob/master/lib/core/httpclient.js" target="_blank">HttpClient</a> will initialize to <code>app.httpclient</code> automatically during the application&apos;s initialization.
Also added an method <code>app.curl(url, options)</code>, which is equivalent to the <code>app.httpclient.request(url, options)</code>.</p>
<p>So you can easily use <code>app.curl</code> to complete a HTTP request.</p>
<pre><code class="lang-js"><span class="hljs-comment">// app.js</span>
<span class="hljs-built_in">module</span>.exports = app =&gt; {
  app.beforeStart(<span class="hljs-function"><span class="hljs-keyword">function</span>* (<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">// example: read the version info on https://registry.npm.taobao.org/beidou-core/latest when it starts</span>
    <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">yield</span> app.curl(<span class="hljs-string">&apos;https://registry.npm.taobao.org/beidou-core/latest&apos;</span>, {
      dataType: <span class="hljs-string">&apos;json&apos;</span>,
    });
    app.logger.info(<span class="hljs-string">&apos;Beidou latest version: %s&apos;</span>, result.data.version);
  });
};
</code></pre>
<h2 id="using-httpclient-by-context">Using HttpClient by Context</h2>
<p>Framework also provides <code>ctx.curl(url, options)</code> and <code>ctx.httpclient</code> in Context, same as app.
So it&apos;s very easy to use <code>ctx.curl()</code> to complete a HTTP request in the Context (such as in the controller)</p>
<pre><code class="lang-js"><span class="hljs-comment">// app/controller/home.js</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">home</span>(<span class="hljs-params">ctx</span>) </span>{
  <span class="hljs-comment">// example: request a npm module&apos;s info</span>
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">yield</span> ctx.curl(<span class="hljs-string">&apos;https://registry.npm.taobao.org/beidou-core/latest&apos;</span>, {
    <span class="hljs-comment">// parse JSON response</span>
    dataType: <span class="hljs-string">&apos;json&apos;</span>,
    <span class="hljs-comment">// timeout of 3s</span>
    timeout: <span class="hljs-number">3000</span>,
  });

  ctx.body = {
    status: result.status,
    headers: result.headers,
    package: result.data,
  };
};
</code></pre>
<h2 id="basic-http-request">Basic HTTP Request</h2>
<p>HTTP has been widely used and have several methods to make request, but the methods are similar. We start with the basic four request methods then move to some more complex scenario.</p>
<p>In the following example, we will complete the request of <a href="https://httpbin.org" target="_blank">https://httpbin.org</a> in the controller.</p>
<h3 id="get">GET</h3>
<p>Reading data almost uses GET request. It is the most common type and widely used in the world of HTTP. And it is also easier to construct a request parameter.</p>
<pre><code class="lang-js"><span class="hljs-comment">// app/controller/get.js</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">get</span>(<span class="hljs-params">ctx</span>) </span>{
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">yield</span> ctx.curl(<span class="hljs-string">&apos;https://httpbin.org/get?foo=bar&apos;</span>);
  ctx.status = result.status;
  ctx.set(result.headers);
  ctx.body = result.data;
};
</code></pre>
<ul>
<li>GET request might not need to set <code>options.method</code>. HttpClient Defalut method is set to <code>GET</code></li>
<li>Return <code>result</code> will contains 3 attributes: <code>status</code>, <code>headers</code> and <code>data</code><ul>
<li><code>status</code>: response status&#xFF0C;for example <code>200</code>, <code>302</code>, <code>404</code>, <code>500</code> and etc</li>
<li><code>headers</code>: response header&#xFF0C;similar to <code>{ &apos;content-type&apos;: &apos;text/html&apos;, ... }</code></li>
<li><code>data</code>: response body&#xFF0C;default HttpClient doesn&apos;t do anything and returns as Buffer directly.
Once the <code>options.dataType</code> is set&#xFF0C;HttpClient will process the <code>data</code> based on the parameters</li>
</ul>
</li>
</ul>
<p>For the complete request parameter <code>options</code> and return value <code>result</code>, refer to below section <a href="#options-parameters-in-detail">options Parameters in Detail</a></p>
<h3 id="post">POST</h3>
<p>The scenario of creating data generally uses the POST request with body parameter, one more parameter compared to GET.</p>
<p>Take sending JSON boy as example:</p>
<pre><code class="lang-js"><span class="hljs-comment">// app/controller/post.js</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">post</span>(<span class="hljs-params">ctx</span>) </span>{
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">yield</span> ctx.curl(<span class="hljs-string">&apos;https://httpbin.org/post&apos;</span>, {
    <span class="hljs-comment">// method is needed</span>
    method: <span class="hljs-string">&apos;POST&apos;</span>,
    <span class="hljs-comment">// telling HttpClient to send data as JSON by contentType</span>
    contentType: <span class="hljs-string">&apos;json&apos;</span>,
    data: {
      hello: <span class="hljs-string">&apos;world&apos;</span>,
      now: <span class="hljs-built_in">Date</span>.now(),
    },
    <span class="hljs-comment">// telling HttpClient to process the return body as JSON format explicitly</span>
    dataType: <span class="hljs-string">&apos;json&apos;</span>,
  });
  ctx.body = result.data;
};
</code></pre>
<p>The following will explain POST to achieve Form function of form submission and file upload in detail.</p>
<h3 id="put">PUT</h3>
<p>Similar to POST, but PUT is better for data updating and replacement. Almost the same parameters as POST except setting method as <code>PUT</code>.</p>
<pre><code class="lang-js"><span class="hljs-comment">// app/controller/put.js</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">put</span>(<span class="hljs-params">ctx</span>) </span>{
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">yield</span> ctx.curl(<span class="hljs-string">&apos;https://httpbin.org/put&apos;</span>, {
    <span class="hljs-comment">// method is needed </span>
    method: <span class="hljs-string">&apos;PUT&apos;</span>,
    <span class="hljs-comment">// telling HttpClient to send data as JSON by contentType</span>
    contentType: <span class="hljs-string">&apos;json&apos;</span>,
    data: {
      update: <span class="hljs-string">&apos;foo bar&apos;</span>,
    },
    <span class="hljs-comment">// telling HttpClient to process the return body as JSON format explicitly</span>
    dataType: <span class="hljs-string">&apos;json&apos;</span>,
  });
  ctx.body = result.data;
};
</code></pre>
<h3 id="delete">DELETE</h3>
<p>DELETE request is to delete the data, request body don&apos;t need to add request body but HttpClient don&apos;t have the limitation.</p>
<pre><code class="lang-js"><span class="hljs-comment">// app/controller/delete.js</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">del</span>(<span class="hljs-params">ctx</span>) </span>{
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">yield</span> ctx.curl(<span class="hljs-string">&apos;https://httpbin.org/delete&apos;</span>, {
    <span class="hljs-comment">// method is needed</span>
    method: <span class="hljs-string">&apos;DELETE&apos;</span>,
    <span class="hljs-comment">// telling HttpClient to process the return body as JSON format explicitly</span>
    dataType: <span class="hljs-string">&apos;json&apos;</span>,
  });
  ctx.body = result.data;
};
</code></pre>
<h2 id="advanced-http-request">Advanced HTTP request</h2>
<p>In some real application scenarios, still have some more complex HTTP requests.</p>
<h3 id="form-submission">Form Submission</h3>
<p>Interfaces of Browser-Oriented Form Submission (without files), usually require <code>content-type: application/x-www-form-urlencoded</code> for the data requesting.</p>
<pre><code class="lang-js"><span class="hljs-comment">// app/controller/form.js</span>
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">form</span>(<span class="hljs-params">ctx</span>) </span>{
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">yield</span> ctx.curl(<span class="hljs-string">&apos;https://httpbin.org/post&apos;</span>, {
    <span class="hljs-comment">// method is needed, supports POST&#xFF0C;PUT and DELETE </span>
    method: <span class="hljs-string">&apos;POST&apos;</span>,
    <span class="hljs-comment">// contentType is not needed, by default HttpClient will send request in application/x-www-form-urlencoded</span>
    data: {
      now: <span class="hljs-built_in">Date</span>.now(),
      foo: <span class="hljs-string">&apos;bar&apos;</span>,
    },
    <span class="hljs-comment">// telling HttpClient to process the return body as JSON format explicitly</span>
    dataType: <span class="hljs-string">&apos;json&apos;</span>,
  });
  ctx.body = result.data.form;
  <span class="hljs-comment">// final response will similar as below: </span>
  <span class="hljs-comment">// {</span>
  <span class="hljs-comment">//   &quot;foo&quot;: &quot;bar&quot;,</span>
  <span class="hljs-comment">//   &quot;now&quot;: &quot;1483864184348&quot;</span>
  <span class="hljs-comment">// }</span>
};
</code></pre>
<h3 id="uploading-files-by-multipart">Uploading Files by Multipart</h3>
<p>Once form submission contains files, submission of requesting data must be <a href="http://tools.ietf.org/html/rfc2388" target="_blank">multipart/form-data</a>
We need to introduce third party module <a href="https://github.com/node-modules/formstream" target="_blank">formstream</a> to generate <code>form</code> objects that can be consumed by HttpClient.</p>
<pre><code class="lang-js"><span class="hljs-comment">// app/controller/multipart.js</span>
<span class="hljs-keyword">const</span> FormStream = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;formstream&apos;</span>);
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">multipart</span>(<span class="hljs-params">ctx</span>) </span>{
  <span class="hljs-keyword">const</span> form = <span class="hljs-keyword">new</span> FormStream();
  <span class="hljs-comment">// set key value</span>
  form.field(<span class="hljs-string">&apos;foo&apos;</span>, <span class="hljs-string">&apos;bar&apos;</span>);
  <span class="hljs-comment">// uploading the current file for test propose</span>
  form.file(<span class="hljs-string">&apos;file&apos;</span>, __filename);

  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">yield</span> ctx.curl(<span class="hljs-string">&apos;https://httpbin.org/post&apos;</span>, {
    <span class="hljs-comment">// method is needed, supports POST&#xFF0C;PUT</span>
    method: <span class="hljs-string">&apos;POST&apos;</span>,
    <span class="hljs-comment">// generate request headers following the requirements of multipart/form-data</span>
    headers: form.headers(),
    <span class="hljs-comment">// submitted by stream mode</span>
    stream: form,
   <span class="hljs-comment">// telling HttpClient to process the return body as JSON format explicitly</span>
    dataType: <span class="hljs-string">&apos;json&apos;</span>,
  });
  ctx.body = result.data.files;
  <span class="hljs-comment">// final response will similar as below:</span>
  <span class="hljs-comment">// {</span>
  <span class="hljs-comment">//   &quot;file&quot;: &quot;&apos;use strict&apos;;\n\nconst For....&quot;</span>
  <span class="hljs-comment">// }</span>
};
</code></pre>
<p>Of course, you can add more files to achieve the requirements of upload multiple files at one time by <code>form.file()</code></p>
<pre><code class="lang-js">form.file(<span class="hljs-string">&apos;file1&apos;</span>, file1);
form.file(<span class="hljs-string">&apos;file2&apos;</span>, file2);
</code></pre>
<h3 id="uploading-files-in-stream-mode">Uploading files in Stream Mode</h3>
<p>In fact, Stream is the leading in the world of Node.js.
If the server supports streaming, the most friendly way is to send the Stream directly. Actually, Stream will be sent in <code>Transfer-Encoding: chunked</code> transmission coding format, which is implemented by <a href="https://nodejs.org/api/http.html" target="_blank">HTTP</a> module automatically.</p>
<pre><code class="lang-js"><span class="hljs-comment">// app/controller/stream.js</span>
<span class="hljs-keyword">const</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;fs&apos;</span>);
<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span>* <span class="hljs-title">stream</span>(<span class="hljs-params">ctx</span>) </span>{
  <span class="hljs-comment">// uploading the current file for test propose</span>
  <span class="hljs-keyword">const</span> fileStream = fs.createReadStream(__filename);
  <span class="hljs-comment">// httpbin.org not support stream mode, use the local stream interface instead</span>
  <span class="hljs-keyword">const</span> url = <span class="hljs-string">`<span class="hljs-subst">${ctx.protocol}</span>://<span class="hljs-subst">${ctx.host}</span>/stream`</span>;
  <span class="hljs-keyword">const</span> result = <span class="hljs-keyword">yield</span> ctx.curl(url, {
    <span class="hljs-comment">// method is needed, supports POST&#xFF0C;PUT</span>
    method: <span class="hljs-string">&apos;POST&apos;</span>,
    <span class="hljs-comment">// submitted by stream mode</span>
    stream: fileStream,
  });
  ctx.status = result.status;
  ctx.set(result.headers);
  ctx.body = result.data;
  <span class="hljs-comment">// final response will similar as below:</span>
  <span class="hljs-comment">// {&quot;streamSize&quot;:574}</span>
};
</code></pre>
<h2 id="options-parameters-in-detail">options Parameters in Detail</h2>
<p>Due to the complexity of HTTP Request, the options parameters of <code>httpclient.request(url, options)</code> quite large. The actual usage of each optional parameter will be shown with descriptions and coding as below.</p>
<h3 id="default-httpclient-global-configuration">Default HttpClient Global Configuration</h3>
<pre><code class="lang-js"><span class="hljs-comment">// config/config.default.js</span>
exports.httpclient = {
  <span class="hljs-comment">// whether to enable local DNS cache, default disable, enable will have two characteristics</span>
  <span class="hljs-comment">// 1. All DNS lookup will prefer to use the cache by default, even DNS query error does not affects the application</span>
  <span class="hljs-comment">// 2. For the same hostname, query only once during the interval of dnsCacheLookupInterval (default 10s)</span>
  enableDNSCache: <span class="hljs-literal">false</span>,
  <span class="hljs-comment">// minimum interval of DNS query on the same hostname</span>
  dnsCacheLookupInterval: <span class="hljs-number">10000</span>,
  <span class="hljs-comment">// maximum number of hostname DNS cache simultaneously, default 1000</span>
  dnsCacheMaxLength: <span class="hljs-number">1000</span>,

  request: {
    <span class="hljs-comment">// default timeout of request</span>
    timeout: <span class="hljs-number">3000</span>,
  },

  httpAgent: {
    <span class="hljs-comment">// default enable http KeepAlive</span>
    keepAlive: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// idle KeepAlive socket can survive for 4 seconds</span>
    freeSocketKeepAliveTimeout: <span class="hljs-number">4000</span>,
    <span class="hljs-comment">// when sockets have no activity for more than 30s, it will be processed as timeout</span>
    timeout: <span class="hljs-number">30000</span>,
    <span class="hljs-comment">// maximum number of sockets allow to be created</span>
    maxSockets: <span class="hljs-built_in">Number</span>.MAX_SAFE_INTEGER,
    <span class="hljs-comment">// maximum number of idle sockets</span>
    maxFreeSockets: <span class="hljs-number">256</span>,
  },

  httpsAgent: {
    <span class="hljs-comment">// default enable https KeepAlive</span>
    keepAlive: <span class="hljs-literal">true</span>,
    <span class="hljs-comment">// idle KeepAlive socket can survive for 4 seconds</span>
    freeSocketKeepAliveTimeout: <span class="hljs-number">4000</span>,
    <span class="hljs-comment">// when sockets have no activity for more than 30s, it will be processed as timeout</span>
    timeout: <span class="hljs-number">30000</span>,
    <span class="hljs-comment">// maximum number of sockets allow to be created</span>
    maxSockets: <span class="hljs-built_in">Number</span>.MAX_SAFE_INTEGER,
    <span class="hljs-comment">// maximum number of idle sockets</span>
    maxFreeSockets: <span class="hljs-number">256</span>,
  },
};
</code></pre>
<p>Application can overrides the configuration by <code>config/config.default.js</code> </p>
<h3 id="data-object"><code>data: Object</code></h3>
<p>The request data will select the correct processing method automatically based on the <code>method</code>.</p>
<ul>
<li>GET&#xFF0C;HEAD: processed by <code>querystring.stringify(data)</code> then append to the query parameters of url.</li>
<li>POST&#xFF0C;PUT, DELETE and etc: further judgments and process according to <code>contentType</code>.<ul>
<li><code>contentType = json</code>: processed by <code>JSON.stringify(data)</code> and set it as body before sending.</li>
<li>others: processed by <code>querystring.stringify(data)</code> and set it as body before sending</li>
</ul>
</li>
</ul>
<pre><code class="lang-js"><span class="hljs-comment">// GET + data</span>
ctx.curl(url, {
  data: { foo: <span class="hljs-string">&apos;bar&apos;</span> },
});

<span class="hljs-comment">// POST + data</span>
ctx.curl(url, {
  method: <span class="hljs-string">&apos;POST&apos;</span>,
  data: { foo: <span class="hljs-string">&apos;bar&apos;</span> },
});

<span class="hljs-comment">// POST + JSON + data</span>
ctx.curl(url, {
  method: <span class="hljs-string">&apos;POST&apos;</span>,
  contentType: <span class="hljs-string">&apos;json&apos;</span>,
  data: { foo: <span class="hljs-string">&apos;bar&apos;</span> },
});
</code></pre>
<h3 id="dataasquerystring-boolean"><code>dataAsQueryString: Boolean</code></h3>
<p>Once <code>dataAsQueryString=true</code> is set, even under POST, it will forces <code>options.data</code> to be processed by <code>querystring.stringify</code> then append to the <code>url</code> query parameters </p>
<p>The application scenarios that sending data using <code>stream</code> and pass additional request parameters by <code>url</code> query can be well resolved.</p>
<pre><code class="lang-js">ctx.curl(url, {
  method: <span class="hljs-string">&apos;POST&apos;</span>,
  dataAsQueryString: <span class="hljs-literal">true</span>,
  data: {
    <span class="hljs-comment">// generally it would be some validation parameters such as access token, etc.</span>
    accessToken: <span class="hljs-string">&apos;some access token value&apos;</span>,
  },
  stream: myFileStream,
});
</code></pre>
<h3 id="content-stringbuffer"><code>content: String|Buffer</code></h3>
<p>Set request Context, if the parameter is set, it will ignore the <code>data</code> parameters</p>
<pre><code class="lang-js">ctx.curl(url, {
  method: <span class="hljs-string">&apos;POST&apos;</span>,
  <span class="hljs-comment">// Sending the raw xml data without HttpClient&apos;s to do processing </span>
  content: <span class="hljs-string">&apos;&lt;xml&gt;&lt;hello&gt;world&lt;/hello&gt;&lt;/xml&gt;&apos;</span>,
  headers: {
    <span class="hljs-string">&apos;content-type&apos;</span>: <span class="hljs-string">&apos;text/html&apos;</span>,
  },
});
</code></pre>
<h3 id="stream-readstream"><code>stream: ReadStream</code></h3>
<p>Set request context&apos;s readable stream, default <code>null</code>.
If the parameter is set , HttpClient will ignore <code>data</code> and <code>content</code></p>
<pre><code class="lang-js">ctx.curl(url, {
  method: <span class="hljs-string">&apos;POST&apos;</span>,
  stream: fs.createReadStream(<span class="hljs-string">&apos;/path/to/read&apos;</span>),
});
</code></pre>
<h3 id="writestream-writestream"><code>writeStream: WriteStream</code></h3>
<p>Set receive response data&apos;s writeable stream, default <code>null</code>.
Once the parameter is set, response <code>result.data</code> is set to <code>null</code> because all data are written to <code>writeStream</code>.</p>
<pre><code class="lang-js">ctx.curl(url, {
  writeStream: fs.createWriteStream(<span class="hljs-string">&apos;/path/to/store&apos;</span>),
});
</code></pre>
<h3 id="consumewritestream-boolean"><code>consumeWriteStream: Boolean</code></h3>
<p>Whether to wait for <code>writeStream</code> completely finished as the response well received
This parameter is not recommended to modify the default value, unless we know it&apos;s side effect are acceptable. Otherwise, the <code>writeStream</code> data is likely to be incomplete.</p>
<h3 id="method-string"><code>method: String</code></h3>
<p>Set request method, default <code>GET</code>. Support all <code>GET&#x3001;POST&#x3001;PUT&#x3001;DELETE&#x3001;PATCH</code> and so on <a href="https://nodejs.org/api/http.html#http_http_methods" target="_blank">all HTTP methods</a>&#x3002;</p>
<h3 id="contenttype-string"><code>contentType: String</code></h3>
<p>Set request data format &#xFF0C;default <code>undefined</code>&#xFF0C;HttpClient will sets automatically based on the <code>data</code> and <code>content</code> parameters.
When <code>data</code> is object, the default setting would be <code>form</code>. Support <code>json</code> format.</p>
<p>If need to send <code>data</code> by JSON</p>
<pre><code class="lang-js">ctx.curl(url, {
  method: <span class="hljs-string">&apos;POST&apos;</span>,
  data: {
    foo: <span class="hljs-string">&apos;bar&apos;</span>,
    now: <span class="hljs-built_in">Date</span>.now(),
  },
  contentType: <span class="hljs-string">&apos;json&apos;</span>,
});
</code></pre>
<h3 id="datatype-string"><code>dataType: String</code></h3>
<p>Set the response data format, default return the raw buffer formatted data without processing. Support <code>text</code> and <code>json</code> </p>
<p><strong>Note: If <code>json</code> is set&#xFF0C;a <code>JSONResponseFormatError</code>  error would be thrown if fails to parse the response data.</strong></p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> jsonResult = <span class="hljs-keyword">yield</span> ctx.curl(url, {
  dataType: <span class="hljs-string">&apos;json&apos;</span>,
});
<span class="hljs-built_in">console</span>.log(jsonResult.data);

<span class="hljs-keyword">const</span> htmlResult = <span class="hljs-keyword">yield</span> ctx.curl(url, {
  dataType: <span class="hljs-string">&apos;text&apos;</span>,
});
<span class="hljs-built_in">console</span>.log(htmlResult.data);
</code></pre>
<h3 id="fixjsonctlchars-boolean"><code>fixJSONCtlChars: Boolean</code></h3>
<p>Whether filter the special control characters in the response data (U+0000 ~ U+001F)&#xFF0C;default <code>false</code>
Typically, the JSON data returned by some CGI system might contains such special control characters, which can be filter automatically by setting the parameters.</p>
<pre><code class="lang-js">ctx.curl(url, {
  fixJSONCtlChars: <span class="hljs-literal">true</span>,
  dataType: <span class="hljs-string">&apos;json&apos;</span>,
});
</code></pre>
<h3 id="headers-object"><code>headers: Object</code></h3>
<p>Custom request headers</p>
<pre><code class="lang-js">ctx.curl(url, {
  headers: {
    <span class="hljs-string">&apos;x-foo&apos;</span>: <span class="hljs-string">&apos;bar&apos;</span>,
  },
});
</code></pre>
<h3 id="timeout-numberarray"><code>timeout: Number|Array</code></h3>
<p>Timeout of request, default <code>[ 5000, 5000 ]</code>, timeout of connection creation is 5s, and the timeout of receive response is 5s.</p>
<pre><code class="lang-js">ctx.curl(url, {
  <span class="hljs-comment">// 3s timeout of connection creation, and the 3s timeout of receive response</span>
  timeout: <span class="hljs-number">3000</span>,
});

ctx.curl(url, {
  <span class="hljs-comment">// 1s timeout of connection creation, and the 30s timeout of receive response for the responsing of larger scenarios</span>
  timeout: [ <span class="hljs-number">1000</span>, <span class="hljs-number">30000</span> ],
});
</code></pre>
<h3 id="agent-httpagent"><code>agent: HttpAgent</code></h3>
<p>Allows to override the default HttpAgent through this parameter. If you don&apos;t want to enable KeepAlive, set this parameter to <code>false</code>.</p>
<pre><code class="lang-js">ctx.curl(url, {
  agent: <span class="hljs-literal">false</span>,
});
</code></pre>
<h3 id="httpsagent-httpsagent"><code>httpsAgent: HttpsAgent</code></h3>
<p>Allows to override the default HttpsAgent through this parameter. If you don&apos;t want to enable KeepAlive, set this parameter to <code>false</code>.</p>
<pre><code class="lang-js">ctx.curl(url, {
  httpsAgent: <span class="hljs-literal">false</span>,
});
</code></pre>
<h3 id="auth-string"><code>auth: String</code></h3>
<p>Parameter of Simple login authorization (Basic Authentication), will send the login information to the <code>Authorization</code> request in clear form.</p>
<pre><code class="lang-js">ctx.curl(url, {
  <span class="hljs-comment">// parameter must follow the format of `user:password`</span>
  auth: <span class="hljs-string">&apos;foo:bar&apos;</span>,
});
</code></pre>
<h3 id="digestauth-string"><code>digestAuth: String</code></h3>
<p>Parameter of the Digest Authentication. If the parameter is set, it will attempt to generate the <code>Authorization</code> request header for the 401 response automatically then try requesting for authorization once.</p>
<pre><code class="lang-js">ctx.curl(url, {
  <span class="hljs-comment">// parameter must follow the format of `user:password`</span>
  digestAuth: <span class="hljs-string">&apos;foo:bar&apos;</span>,
});
</code></pre>
<h3 id="followredirect-boolean"><code>followRedirect: Boolean</code></h3>
<p>Whether to follow 3xx redirect response, default <code>false</code></p>
<pre><code class="lang-js">ctx.curl(url, {
  followRedirect: <span class="hljs-literal">true</span>,
});
</code></pre>
<h3 id="maxredirects-number"><code>maxRedirects: Number</code></h3>
<p>Set the maximum number of automatic redirects to prevent the endless redirect loop, default 10 times.
The parameter should not be set too large and only works in the <code>followRedirect=true</code></p>
<pre><code class="lang-js">ctx.curl(url, {
  followRedirect: <span class="hljs-literal">true</span>,
  <span class="hljs-comment">// maximum allowed redirect 5 times</span>
  maxRedirects: <span class="hljs-number">5</span>,
});
</code></pre>
<h3 id="formatredirecturl-functionfrom-to"><code>formatRedirectUrl: Function(from, to)</code></h3>
<p><code>formatRedirectUrl</code> allow us to customize the implementation of 302&#x3001;301 other redirect URL splicing, default <code>url.resolve (from, to)</code>.</p>
<pre><code class="lang-js">ctx.curl(url, {
  formatRedirectUrl: (<span class="hljs-keyword">from</span>, to) =&gt; {
    <span class="hljs-comment">// for example you can correct the redirection of wrong url here</span>
    <span class="hljs-keyword">if</span> (to === <span class="hljs-string">&apos;//foo/&apos;</span>) {
      to = <span class="hljs-string">&apos;/foo&apos;</span>;
    }
    <span class="hljs-keyword">return</span> url.resolve(<span class="hljs-keyword">from</span>, to);
  },
});
</code></pre>
<h3 id="beforerequest-functionoptions"><code>beforeRequest: Function(options)</code></h3>
<p>HttpClient will attempt to invoke the <code>beforeRequest</code> hook before requesting officially, allowing us to make the last modification of the request parameter here.</p>
<pre><code class="lang-js">ctx.curl(url, {
  beforeRequest: options =&gt; {
    <span class="hljs-comment">// For example, we can set the global request ID to facilitate log tracking</span>
    options.headers[<span class="hljs-string">&apos;x-request-id&apos;</span>] = uuid.v1();
  },
});
</code></pre>
<h3 id="streaming-boolean"><code>streaming: Boolean</code></h3>
<p>Whether to return the response stream directly, default <code>false</code>
After enable streaming, HttpClient will return immediately after getting the response object res,
At this moment <code>result.headers</code> and <code>result.status</code> can be read, but still cannot read the data</p>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">yield</span> ctx.curl(url, {
  streaming: <span class="hljs-literal">true</span>,
});

<span class="hljs-built_in">console</span>.log(result.status, result.data);
<span class="hljs-comment">// result.res is a ReadStream Object</span>
ctx.body = result.res;
</code></pre>
<p><strong>if res is not passed to body directly, then we must consume this stream and do well in error handling.</strong></p>
<h3 id="gzip-boolean"><code>gzip: Boolean</code></h3>
<p>Whether to support gzip response format, default <code>false</code>
After enable gzip, HttpClient will set <code>Accept-Encoding: gzip</code> header and extract the data with <code>Content-Encoding: gzip</code> response header automatically.</p>
<pre><code class="lang-js">ctx.curl(url, {
  gzip: <span class="hljs-literal">true</span>,
});
</code></pre>
<h3 id="timing-boolean"><code>timing: Boolean</code></h3>
<p>Whether to enable the time measurement for each phase, default <code>false</code>
After enable the timing, you can get the time measurements of HTTP request (in milliseconds) from the <code>result.res.timing</code>.
Through these measurements, we can easily locate the slowest environment in the request, similar to the Chrome network timing.</p>
<p>Measurement timing&apos;s analysis of each stage:</p>
<ul>
<li>queuing: allocating socket time consuming </li>
<li>dnslookup: DNS queries time consuming </li>
<li>connected: socket three handshake success time consuming </li>
<li>requestSent: requesting full data time consuming </li>
<li>waiting: first byte to received response time consuming </li>
<li>contentDownload: full response data time consuming</li>
</ul>
<pre><code class="lang-js"><span class="hljs-keyword">const</span> result = <span class="hljs-keyword">yield</span> ctx.curl(url, {
  timing: <span class="hljs-literal">true</span>,
});
<span class="hljs-built_in">console</span>.log(result.res.timing);
<span class="hljs-comment">// {</span>
<span class="hljs-comment">//   &quot;queuing&quot;:29,</span>
<span class="hljs-comment">//   &quot;dnslookup&quot;:37,</span>
<span class="hljs-comment">//   &quot;connected&quot;:370,</span>
<span class="hljs-comment">//   &quot;requestSent&quot;:1001,</span>
<span class="hljs-comment">//   &quot;waiting&quot;:1833,</span>
<span class="hljs-comment">//   &quot;contentDownload&quot;:3416</span>
<span class="hljs-comment">// }</span>
</code></pre>
<h3 id="ca&#xFF0C;rejectunauthorized&#xFF0C;pfx&#xFF0C;key&#xFF0C;cert&#xFF0C;passphrase&#xFF0C;ciphers&#xFF0C;secureprotocol"><code>ca&#xFF0C;rejectUnauthorized&#xFF0C;pfx&#xFF0C;key&#xFF0C;cert&#xFF0C;passphrase&#xFF0C;ciphers&#xFF0C;secureProtocol</code></h3>
<p>These are parameters are passed to the  <a href="https://nodejs.org/api/https.html" target="_blank">HTTPS</a> modules&#xFF0C;details refer to <a href="https://nodejs.org/api/https.html#https_https_request_options_callback" target="_blank"><code>https.request(options, callback)</code></a>&#x3002;</p>
<h2 id="debugging-aid">Debugging Aid</h2>
<p>Framework provides <a href="https://github.com/eggjs/egg-development-proxyagent" target="_blank">egg-development-proxyagent</a> plugin to help developers to debug.</p>
<p>Install and enable pulgin:</p>
<pre><code class="lang-bash">$ npm i egg-development-proxyagent --save-dev
</code></pre>
<pre><code class="lang-js"><span class="hljs-comment">// config/plugin.local.js</span>
exports.proxyagent = {
  enable: <span class="hljs-literal">true</span>,
  package: <span class="hljs-string">&apos;egg-development-proxyagent&apos;</span>,
}
</code></pre>
<p>Open capture tools, we can use <a href="https://www.charlesproxy.com/" target="_blank">charles</a> or <a href="http://www.telerik.com/fiddler" target="_blank">fiddler</a>, here we take to <a href="https://github.com/alibaba/anyproxy" target="_blank">anyproxy</a> demonstrate</p>
<pre><code class="lang-bash">$ npm install anyproxy -g
$ anyproxy --port 8888
</code></pre>
<p>Starting application using environment variables:</p>
<pre><code class="lang-bash">$ http_proxy=http://127.0.0.1:8888 npm run dev
</code></pre>
<p>Then it works correctly, and all requests that go through HttpClient can be viewed in the consle of <a href="http://localhost:8002" target="_blank">http://localhost:8002</a>.</p>
<p><img src="https://cloud.githubusercontent.com/assets/227713/21976937/06a63694-dc0f-11e6-98b5-e9e279c4867c.png" alt="anyproxy"></p>
<p><strong>Note: the pulgin only start in local environments by defalut</strong></p>
<h2 id="known-issues">Known issues</h2>
<h3 id="connection-timeout">Connection Timeout</h3>
<ul>
<li>Exception: <code>ConnectionTimeoutError</code> </li>
<li>Scene: usually occurred by the DNS query is slow, or the network is slow between the client and server</li>
<li>Troubleshooting Suggestion: increase the <code>timeout</code> parameter appropriately.</li>
</ul>
<h3 id="service-response-timeout">Service Response Timeout</h3>
<ul>
<li>Exception: <code>ResponseTimeoutError</code></li>
<li>Scene: usually occurred by network is slower between the client and server, and happens when the data is relatively large.</li>
<li>Troubleshooting Suggestion: increase the <code>timeout</code> parameter appropriately.</li>
</ul>
<h3 id="service-disconnect">Service Disconnect</h3>
<ul>
<li>Exception: <code>ResponseError, code: ECONNRESET</code></li>
<li>Scene: usually the server actively disconnects the socket connection, causing the HTTP request link exceptions.</li>
<li>Troubleshooting Suggestion: please check if server has network exception at that time</li>
</ul>
<h3 id="service-is-unreachable">Service is unreachable</h3>
<ul>
<li>Exception: <code>RequestError, code: ECONNREFUSED, status: -1</code></li>
<li>Scene: usually because the requested URL which attached IP or the port cannot connect successfully.</li>
<li>Troubleshooting Suggestion: make sure the IP or port is set correctly</li>
</ul>
<h3 id="domain-name-is-not-existing">Domain name is not existing</h3>
<ul>
<li>Exception: <code>RequestError, code: ENOTFOUND, status: -1</code></li>
<li>Scene: usually the domain name requested by URL cannot be resolved by DNS successfully.</li>
<li>Troubleshooting Suggestion: make sure the domain name exists, and also check to see if the DNS service is properly configured.</li>
</ul>
<h3 id="json-response-data-format-error">JSON Response data format error</h3>
<ul>
<li>Exception: <code>JSONResponseFormatError</code></li>
<li>scene: the <code>dataType=json</code> is set and this exception is thrown in response data that does not match JSON format.</li>
<li>Troubleshooting Suggestion: make sure that the server no matter what situations are returns the data in JSON format correctly.</li>
</ul>
<h2 id="global-request-and-response-events">Global <code>request</code> and <code>response</code> events</h2>
<p>In enterprise application scenarios, generally a unified tracer log is needed.
To facilitate monitoring HttpClient requests and responses on the app level, we agreed on global <code>request</code> and <code>response</code> to expose these two events.</p>
<pre><code class="lang-bash">    init options
        |
        V
    emit `request` event
        |
        V
    send request and receive response
        |
        V
    emit `response` event
        |
        V
       end
</code></pre>
<h3 id="request-event-occurs-before-the-network-operation"><code>request</code> event occurs before the network operation</h3>
<p>A <code>request</code> event is triggered before the request is sent, allowing blocking of the request.</p>
<pre><code class="lang-js">app.httpclient.on(<span class="hljs-string">&apos;request&apos;</span>, req =&gt; {
  req.url <span class="hljs-comment">//request url</span>
  req.ctx <span class="hljs-comment">//context of the request</span>

  <span class="hljs-comment">// you can set some trace headers here for full link tracking propose</span>
});
</code></pre>
<h3 id="response-event-occurs-after-the-end-of-network-operation"><code>response</code> event occurs after the end of network operation</h3>
<p>After the end of request, a <code>response</code> event is triggered, so that the external event can be subscribed to the log printing.</p>
<pre><code class="lang-js">app.httpclient.on(<span class="hljs-string">&apos;response&apos;</span>, result =&gt; {
  result.res.status
  result.ctx <span class="hljs-comment">//context of the request</span>
  result.req <span class="hljs-comment">//the corresponding req object, which the req in the request event</span>

});
</code></pre>
<h2 id="example">Example</h2>
<p>Full examples can be found on <a href="https://github.com/eggjs/examples/blob/master/httpclient" target="_blank">eggjs/exmaples/httpclient</a> .</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="logger.html" class="navigation navigation-prev " aria-label="Previous page: Logger">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="cookie-and-session.html" class="navigation navigation-next " aria-label="Next page: Cookie & Session">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"HttpClient","level":"1.5.4","depth":2,"next":{"title":"Cookie & Session","level":"1.5.5","depth":2,"path":"core/cookie-and-session.md","ref":"core/cookie-and-session.md","articles":[]},"previous":{"title":"Logger","level":"1.5.3","depth":2,"path":"core/logger.md","ref":"core/logger.md","articles":[]},"dir":"ltr"},"config":{"plugins":["antsay","-sharing","styles-less","livereload"],"styles":{"website":"website-1510989186484.css"},"pluginsConfig":{"antsay":{"useIdentifier":false,"shortName":"","appId":"","key":""},"styles-less":{},"livereload":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"Beidou Document","gitbook":">= 3.2.0","description":"Beidou Document"},"file":{"path":"core/http-client.md","mtime":"2017-11-17T13:14:08.000Z","type":"markdown"},"gitbook":{"version":"3.2.2","time":"2017-11-18T07:04:22.028Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="https://say.alipay.net/public/antsay.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-antsay/bootstrap.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-livereload/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

